# TfL Status Service Configuration

tfl {
  # Unique node identifier (override per instance)
  node-id = "node-1"
  node-id = ${?TFL_NODE_ID}

  http {
    port = 8080
    port = ${?TFL_HTTP_PORT}
  }

  refresh {
    interval = 30s
    jitter = 5s
    recent-enough-threshold = 5s
    scatter-gather-timeout = 2s
  }

  rate-limit {
    requests-per-minute = 100
  }

  circuit-breaker {
    failure-threshold = 5
    open-duration = 30s
  }

  retry {
    max-retries = 3
    base-delay = 1s
    max-delay = 30s
    jitter-factor = 0.25
  }
}

# Pekko configuration
pekko {
  loglevel = "INFO"
  stdout-loglevel = "INFO"

  actor {
    provider = "cluster"

    serialization-bindings {
      "com.ig.tfl.model.TubeStatus" = jackson-json
    }
  }

  remote.artery {
    canonical {
      hostname = "127.0.0.1"
      hostname = ${?PEKKO_HOST}
      port = 2551
      port = ${?PEKKO_PORT}
    }
  }

  cluster {
    seed-nodes = [
      "pekko://tfl-cluster@127.0.0.1:2551"
    ]
    seed-nodes = ${?PEKKO_SEED_NODES}

    downing-provider-class = "org.apache.pekko.cluster.sbr.SplitBrainResolverProvider"

    # Multi-datacenter support (production)
    # Tag nodes with their DC for locality-aware replication
    multi-data-center {
      self-data-center = "dc-local"
      self-data-center = ${?PEKKO_DC}
      # Cross-DC failure detection is more lenient (WAN latency)
      failure-detector {
        acceptable-heartbeat-pause = 10s
      }
    }

    # Distributed Data configuration - aggressive replication
    distributed-data {
      # Fast gossip for quick convergence (default is 2s)
      gossip-interval = 200ms
      # Fast subscriber notification
      notify-subscribers-interval = 100ms
      # Use delta-CRDT for efficient replication
      delta-crdt.enabled = on

      # Cross-DC replication (when multi-DC enabled)
      # Prefer local DC, async replicate to remote
      # prefer-oldest = on  # Uncomment for DC-aware read/write
    }
  }

  # HTTP settings
  http {
    server {
      idle-timeout = 60s
      request-timeout = 30s
    }
  }

  # Serialization for CRDT
  serialization.jackson {
    jackson-json {
      serialization-features {
        WRITE_DATES_AS_TIMESTAMPS = off
      }
    }
  }
}

# Logback configuration reference
# See logback.xml for detailed logging configuration
